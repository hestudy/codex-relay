# Project Brief: codex-relay（面向不受支持国家/地区用户的 Codex 服务中转站）

## Executive Summary
- 产品概念：为不受支持国家/地区的用户提供一个“Codex 请求中转站”，前端/客户端将请求发往中转站，由中转站按策略转发到 Codex，并将响应透传回用户。
- 主要问题：目标用户无法直接访问或稳定使用 Codex 服务，且存在合规与隐私风险。
- 目标市场：需要使用 Codex 能力但受地域限制的个人与小团队开发者、初创公司、教育与研究机构等。
- 核心价值：在确保隐私与合规边界的前提下，提供稳定、低时延、可控的代理转发能力，解锁 Codex 使用场景与业务价值。


## Problem Statement（问题陈述）
- 现状与痛点：
  - 目标地区用户无法直接访问 Codex 或成功率低，导致开发、集成与使用受阻。
  - 即便能访问，也存在 IP 不稳定、账号共用、限流失衡等问题，影响可靠性与合规性。
  - 对隐私与合规的担忧使得“是否记录请求正文”“如何做观测与审计”成为关键。
- 影响：
  - 阻碍目标用户与团队采用 Codex，降低开发效率与创新速度。
  - 业务无法验证或扩张，错失市场机会与学习曲线。
- 既有方案不足：
  - 通用代理或自建直连常缺乏稳定固定出口 IP、账号池健康管理、SSE 透传等针对 AI/LLM 场景的能力。
- 紧迫性：
  - 市场窗口与使用需求当前即存在；以最小可用方案快速落地可立刻产生价值与反馈。

## Proposed Solution（方案概述）
- 核心思路：
  - 基于 Cloudflare Workers + KV + D1 + Queues 构建轻量控制面与数据面分层的中转站。
  - 入站使用自有 `X-API-Key` 鉴权，租户级隔离限流/并发/配额；请求规范化与安全头部策略；统一错误模型；透传 JSON 与流式响应（SSE/分块）。
  - 账号池健康检测与熔断，失败快速摘除，指数退避，最终一致恢复；仅记录元数据，不存请求正文。
  - 出口采用固定 IP 代理集群与地域绑定，确保“账号不共用 IP”，实现就近接入与稳定 egress。
- 差异化：
  - 明确“账号:固定IP=1:N（小 N 冗余）”的绑定策略，不跨账号共享。
  - 面向 AI 场景优化：SSE 透传、TransformStream、最小化观测打点、统一错误与重试模型。
- 成功理由：
  - 将复杂度集中在轻量可演进的控制面，快速上线 MVP，逐步强化可靠性与扩展性。

## Target Users（目标用户）
- 主要用户群（Primary）：
  - 受地域限制但需要稳定访问 Codex 的个人开发者、小型团队与初创公司。
  - 希望使用 codex 进行 vide coding 的程序员或敢于尝试的用户。
  - 需求：稳定接入、低时延、可观测、简单集成、隐私有保障。
- 次要用户群（Secondary）：
  - 教育和研究机构、技术博主或工具作者，为其用户提供“中转集成能力”。

## Goals & Success Metrics（目标与成功衡量）
- 业务目标：
  - 在两周内上线 MVP 并服务首批 10-20 个活跃租户。
  - 将 Codex 请求成功率提升至可用阈值（如 >99% 成功转发）。
- 用户成功度量：
  - 平均端到端延迟控制在目标范围（例如 P95 < 1.2×直连时延）。
  - 集成时间小于 0.5 天，提供清晰 SDK/示例或简单的 HTTP 接入文档。
- KPIs：
  - 成功转发率、SSE 透传成功率、P95/P99 延迟、账号健康度与熔断恢复时间、租户留存与活跃度。

## MVP Scope（MVP 范围）
- Must-Have 核心特性：
  - 边缘入口（Workers）+ `X-API-Key` 鉴权 + KV 限流。
  - 请求规范化与安全头部策略（剥离/改写敏感 headers）。
  - 同步 JSON 与 SSE/分块流式响应透传。
  - 账号池健康与熔断（基础版）：失败快速摘除、指数退避、时间窗禁用与恢复。
  - 仅记录元数据的观测（时间、区域、状态、延迟、账号ID、用量），保留 30 天。
- Out of Scope（MVP 不包含）：
  - 高级策略引擎（复杂规则、灰度控制）。
  - 自动扩缩容与跨地域智能路由优化。
  - 完整计费与报表系统。
- MVP 成功标准：
  - 列出的 Must-Have 在目标延迟与稳定性指标下稳定运行；首批租户完成集成并持续活跃。

## Post-MVP Vision（MVP 之后的愿景）
- 第二阶段（Phase 2）能力：
  - 多地域出口集群的自动扩缩容与健康自愈；租户级配额/计费与报表（默认 Phase 2，资源允许可前置至 MVP 部分能力）；可插拔策略引擎。
- 长期愿景（1-2 年）：
  - 跨云/跨地域的智能出口路由（成本/时延/成功率多目标优化）；隐私增强代理与零信任能力。
- 扩展机会：
  - 兼容更多上游 AI 提供商；对接多形态客户端/SDK；企业私有部署方案。

## Technical Considerations（技术考量）
- 平台与性能：
  - 目标平台：Cloudflare Workers；
  - 浏览器/OS：与调用端无强关联，重点确保 SSE/HTTP 流兼容；
  - 性能：支持百人级并发，提供基础限流/重试/超时。
- 技术偏好：
  - 前端：无强制，提供示例与 Postman/HTTP 文档即可；
  - 后端：Workers（TypeScript/JavaScript）；
  - 数据：KV（租户配置/速率计数/动态开关）、D1（账号健康/用量/路由表/审计元数据）、Queues（异步任务）。
  - 基础设施：固定出口 IP 代理集群（优先：新加坡；其后：法兰克福、达拉斯）。
- 架构考虑：
  - 仓库结构：mono 或分层（入口网关、控制面、出口代理）清晰；
  - 服务架构：入口（边缘）—控制面—出口集群；
  - 集成需求：对 Codex API 的兼容与错误模型映射；
  - 安全/合规：不存请求正文，保留必要元数据；严格的密钥与路由策略管理。

## Constraints & Assumptions（约束与假设）
- 约束：
  - 预算：初期以最小成本上线，按用量与地域扩容；
  - 时间：MVP 目标 1 周内可运行，2 周内稳定；
  - 资源：1 名 Workers/Node 工程师主导，后端协同；
  - 技术：Workers 原生不保证固定 egress，需外部出口层支撑固定 IP 绑定。
- 关键假设：
  - 用户接受“仅记录元数据，不存正文”的观测模式；
  - 首批租户主要来自开发者/团队，具备快速集成能力；
  - 目标地域具备可行的固定 IP 资源与成本控制空间。
  - 除“仅保存元数据”外暂无额外隐私/合规约束。

## Risks & Open Questions（风险与开放问题）
注：以下开放问题当前阶段不纳入考虑，后续阶段再评估。
- 关键风险：
  - 出口 IP 成本与地域规模增长导致成本上升；
  - 上游策略变动影响可用性；
  - 账号池健康管理失效导致失败率上升；
  - 隐私/合规要求变化带来额外约束。
- 开放问题：
  - 峰值带宽与成本上限预期？是否需要 WebSocket/批量代理？
  - Cloudflare One 固定 egress 的可行性与性价比？
  - 目标地域与出口节点的优先顺序？
- 需进一步研究：
  - 出口集群选型与部署 SOP；
  - D1 表结构与路由器实现细节；
  - 计费/配额与报表的实现选型。

## Integration Environment Variables（接入环境变量示例）
以下示例用于本地或部署环境中配置 Codex 与中转站所需的最小变量：

```bash
# Relay（中转站）侧
RELAY_BASE_URL="https://relay.example.com"
RELAY_API_KEY="sk-relay-xxxxxxxx"

# 上游 Codex 侧
CODEX_BASE_URL="https://api.codex.com"
CODEX_API_KEY="sk-codex-xxxxxxxx"

# 可选：地域与账号/路由占位（若需要）
RELAY_REGION_HINT="ap-sg"   # 新加坡优先
RELAY_TENANT_ID="your-tenant"
```

## Appendices（附录）
- A. 研究摘要（节选自头脑风暴）
  - 关键主题：固定出口 IP、账号不共用、SSE 透传、KV/D1/Queues 职责分离、仅元数据观测。
  - 重要洞察：Workers 需外部 egress 实现固定 IP；D1+KV 支撑热配置与健康优先路由。
- B. 相关方输入（占位）
  - 将在与首批用户访谈后补充。
- C. 参考资料
  - 头脑风暴文档：`docs/brainstorming-session-results.md`

## Next Steps（下一步）
1. 初始化代码仓与 Workers 项目骨架；
2. 实现 `X-API-Key` 鉴权、KV 限流、头部策略与转发；
3. 打通 JSON 与 SSE 透传路径，加入基础观测与统一错误模型；
4. 设计并初始化 D1 表结构与账号健康/熔断逻辑；
5. 选型与部署至少 2 个地域的固定出口 IP 代理集群（以新加坡为第一优先地域）；
6. 准备最小化接入文档/示例并邀请首批租户试用；
7. 设定与跟踪 KPIs，准备第 2 阶段能力规划。

## PM Handoff（产品交接）
本项目简报为“Codex Relay”的完整上下文。请以“PRD 生成模式”启动，逐节审阅本简报，向我方提出澄清问题或改进建议，并与工程协同推进 MVP 交付。
